<!doctype html><html><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=generator content="Hugo 0.80.0"><title>TeamCity Pipeline - iteration two • A blog by st3v3nhunt</title><meta name=twitter:card content="summary"><meta name=twitter:title content="TeamCity Pipeline - iteration two"><meta name=twitter:description content="Now I have had the TeamCity build pipeline running for a while I have had chance to review how it works."><meta property="og:title" content="TeamCity Pipeline - iteration two"><meta property="og:description" content="Now I have had the TeamCity build pipeline running for a while I have had chance to review how it works."><meta property="og:type" content="article"><meta property="og:url" content="https://st3v3nhunt.github.io/posts/development/teacmity-pipeline-iteration-two/"><meta property="article:published_time" content="2016-04-28T00:00:00+00:00"><meta property="article:modified_time" content="2016-04-28T00:00:00+00:00"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/monokai-sublime.min.css><link rel=stylesheet href=/scss/hyde-hyde.71157e768c4e111a23c3531b95e0cbb59bbef3c9e6901d36247cb53d6b6be258.css integrity="sha256-cRV+doxOERojw1MbleDLtZu+88nmkB02JHy1PWtr4lg="><link rel=stylesheet href=/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58+TzH3icCkSHGoJ+ed7w=" media=print><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body><div class=sidebar><div class=container><div class=sidebar-about><span class=site__title><a href=https://st3v3nhunt.github.io>A blog by st3v3nhunt</a></span><p class=site__description></p></div><div class=collapsible-menu><input type=checkbox id=menuToggle>
<label for=menuToggle>A blog by st3v3nhunt</label><div class=menu-content><div><ul class=sidebar-nav><li><a href=/posts/><span>Posts</span></a></li></ul></div><section class=social><a href=https://twitter.com/st3v3nhunt rel=me><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a><a href=https://github.com/st3v3nhunt rel=me><i class="fab fa-github fa-lg" aria-hidden=true></i></a></section></div></div><div class=copyright>&copy; 2021 st3v3nhunt
<a href=https://creativecommons.org/licenses/by-sa/4.0>CC BY-SA 4.0</a></div><div class=builtwith>Built with <a href=https://gohugo.io>Hugo</a> ❤️ <a href=https://github.com/htr3n/hyde-hyde>hyde-hyde</a>.</div></div></div><div class="content container"><article><header><h1>TeamCity Pipeline - iteration two</h1><div class=post__meta><i class="fas fa-calendar-alt"></i>28-04-2016
in
<a class="badge badge-category" href=/categories/development>DEVELOPMENT</a><br><i class="fas fa-tags"></i><a class="badge badge-tag" href=/tags/ci>ci</a>
<a class="badge badge-tag" href=/tags/development>development</a>
<a class="badge badge-tag" href=/tags/gitlab>gitlab</a>
<a class="badge badge-tag" href=/tags/teamcity>teamcity</a><br><i class="fas fa-clock"></i>4 min read</div></header><div class=post><p>Now I have had the <a href=../teamcity-pipeline/>TeamCity build
pipeline</a> running for a while
I have had chance to review how it works. I have made a number of changes which
I have summarised, along with the reasoning below.</p><h2 id=additional-build-step>Additional build step</h2><p>Originally there were 6 build steps, now there are 7.</p><p>The new build step is executed as the first step and its purpose is to prevent
the build from continuing if a
<a href=https://confluence.jetbrains.com/display/TCD9/History+Build>History Build</a> is
detected. The way I detect a history build is to check the SHA-1 of the default
branch and compare it to the SHA-1 being built.</p><p>This is not quite correct as far as the TeamCity definition goes for a history
build but it works in order to prevent old code being packaged into the NuGet
packages. This was happening whenever a branch was deleted as it was merged
into the default branch.</p><p>There is a check to make sure the build is not for the default branch so the
build will only be stopped when the code being built is the same as that in the
default branch but it is not the default branch that is being built. This has
the impact of branches that contain the same code as the default branch will
not be built, however, we felt the trade off is worth it.</p><p>The script used is ostensibly the same as this:</p><script type=application/javascript src=https://gist.github.com/st3v3nhunt/77cd9205772414576b8009ae195a963a.js></script><p>I have noticed the call out to the GitLab API is failing quite frequently. I
will looking into making it more robust in the future but it can wait for the
time being seen as the worst thing that happens is the history builds are not
detected. Hardly ideal.</p><h2 id=rewritten-nuget-package-step>Rewritten NuGet package step</h2><p>I have rewritten one of the original steps which I have already written about
regarding the creation of the
<a href=../branch-based-nuget-packages-in-teacmity/>NuGet packages</a>.
Since then I have made more changes to the script. The changes are mostly due
to it now being a standalone script and not source code saved in TeamCity. The
other changes are that a datetime stamp is no longer appended to the package
version as it isn&rsquo;t necessary, the pattern <code>-prerelease</code> is sufficient to
indicate a
<a href=https://docs.nuget.org/create/versioning#user-content-creating-prerelease-packages>pre-release NuGet package</a>.
The final change being to ignore errors during the deletion of the output
directory.
The new script is:</p><script type=application/javascript src=https://gist.github.com/st3v3nhunt/54d3ce978e572ca5d00908c6db3ab351.js></script><h2 id=moved-powershell-script-out-of-teamcity>Moved PowerShell script out of TeamCity</h2><p>I was saving the PowerShell script directly in TeamCity but have moved the code
into a file and added it to the code repository. I find having the script
alongside the code is a <em>much</em> better option, some of those reasons being:</p><ul><li>Anybody with access to the code has access to the build script (which is
often different to those with access to the build configuration)</li><li>The script is fully versioned</li><li>The same scrutiny as the rest of the code gets is applied to the script</li><li>Changes to the script are applicable only to the branch where those changes
are rather than everything that runs through the build configuration - this
is perhaps the most important reason</li></ul><p>In the future I would go straight to having the build configuration reference a
script within the code base as the transition from one to the other is tricky.
Mostly involved with getting the script to work properly for the first time
whilst all builds are running, some of which do not have the build script in
the repo.</p><h2 id=updated-failure-conditions>Updated failure conditions</h2><p>I started with four failure conditions and reduced that to three, of which only
two are from the original four.</p><p>The two I have disabled are the build duration and the artifact size. The
reason being, both were failing builds that were perfectly OK. I thought this
might be the case in the early days of the project as the code can and indeed
does change quite significantly from build to build.</p><p>The new failure condition goes hand in hand with the script to stop the build
when a history build is detected. The condition is triggered when the build log
contains some text that is output via the build script when the build has been
identified as one to be stopped.</p><h2 id=more-changes>More changes?</h2><p>For the time being those are the changes that have been made. As and when there
are more I will update this post or create a new one.</p></div><div class="navigation navigation-single"><a href=/posts/development/branch-based-nuget-packages-in-teacmity/ class=navigation-prev><i aria-hidden=true class="fa fa-chevron-left"></i><span class=navigation-tittle>Create branch based NuGet packages in TeamCity</span></a>
<a href=/posts/development/use-personal-slack-for-github-notifications/ class=navigation-next><span class=navigation-tittle>Use personal Slack for GitHub notifications</span>
<i aria-hidden=true class="fa fa-chevron-right"></i></a></div></article></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-21223368-5','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script defer src=https://use.fontawesome.com/releases/v5.12.1/js/all.js integrity=sha384-ZbbbT1gw3joYkKRqh0kWyRp32UAvdqkpbLedQJSlnI8iLQcFVxaGyrOgOJiDQTTR crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js></script><script type=text/javascript>hljs.initHighlightingOnLoad();</script></body></html>