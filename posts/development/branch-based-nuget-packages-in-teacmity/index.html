<!doctype html><html><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=generator content="Hugo 0.80.0"><title>Create branch based NuGet packages in TeamCity • A blog by st3v3nhunt</title><meta name=twitter:card content="summary"><meta name=twitter:title content="Create branch based NuGet packages in TeamCity"><meta name=twitter:description content="As I was reviewing the TeamCity build configuration I&rsquo;d setup with my colleagues, it was pointed out every build was creating a new NuGet package."><meta property="og:title" content="Create branch based NuGet packages in TeamCity"><meta property="og:description" content="As I was reviewing the TeamCity build configuration I&rsquo;d setup with my colleagues, it was pointed out every build was creating a new NuGet package."><meta property="og:type" content="article"><meta property="og:url" content="https://st3v3nhunt.github.io/posts/development/branch-based-nuget-packages-in-teacmity/"><meta property="article:published_time" content="2016-04-13T00:00:00+00:00"><meta property="article:modified_time" content="2016-04-18T00:00:00+00:00"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/monokai-sublime.min.css><link rel=stylesheet href=/scss/hyde-hyde.71157e768c4e111a23c3531b95e0cbb59bbef3c9e6901d36247cb53d6b6be258.css integrity="sha256-cRV+doxOERojw1MbleDLtZu+88nmkB02JHy1PWtr4lg="><link rel=stylesheet href=/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58+TzH3icCkSHGoJ+ed7w=" media=print><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body><div class=sidebar><div class=container><div class=sidebar-about><span class=site__title><a href=https://st3v3nhunt.github.io>A blog by st3v3nhunt</a></span><p class=site__description></p></div><div class=collapsible-menu><input type=checkbox id=menuToggle>
<label for=menuToggle>A blog by st3v3nhunt</label><div class=menu-content><div><ul class=sidebar-nav><li><a href=/posts/><span>Posts</span></a></li></ul></div><section class=social><a href=https://twitter.com/st3v3nhunt rel=me><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a><a href=https://github.com/st3v3nhunt rel=me><i class="fab fa-github fa-lg" aria-hidden=true></i></a></section></div></div><div class=copyright>&copy; 2021 st3v3nhunt
<a href=https://creativecommons.org/licenses/by-sa/4.0>CC BY-SA 4.0</a></div><div class=builtwith>Built with <a href=https://gohugo.io>Hugo</a> ❤️ <a href=https://github.com/htr3n/hyde-hyde>hyde-hyde</a>.</div></div></div><div class="content container"><article><header><h1>Create branch based NuGet packages in TeamCity</h1><div class=post__meta><i class="fas fa-calendar-alt"></i>13-04-2016
in
<a class="badge badge-category" href=/categories/development>DEVELOPMENT</a><br><i class="fas fa-tags"></i><a class="badge badge-tag" href=/tags/ci>ci</a>
<a class="badge badge-tag" href=/tags/development>development</a>
<a class="badge badge-tag" href=/tags/gitlab>gitlab</a>
<a class="badge badge-tag" href=/tags/teamcity>teamcity</a><br><i class="fas fa-clock"></i>3 min read</div></header><div class=post><p>As I was reviewing the TeamCity build configuration I&rsquo;d
<a href=../teamcity-pipeline/>setup</a> with my colleagues, it
was pointed out every build was creating a new NuGet package. Not great when
you consider every branch was triggering a build and most of those branches
were not <code>master</code>.</p><h2 id=the-problem-with-every-branch>The problem with every branch</h2><p>Generally it is not a good idea to have every branch generating a NuGet package
when those branches are often feature branches i.e. code that is in the process
of being reviewed but has not yet been merged into <code>master</code>. These were not
changes we wanted to be published into the NuGet feed and made available to
consumers by default.</p><p>As I was thinking about ways this could be solved I recognised what I really
wanted was a build step controlled by some (probably environment/execution
context) variable. Looking around the Internet to see what other people did
when faced with this situation I found a feature request ticket for exactly
this -
<a href=https://youtrack.jetbrains.com/issue/TW-17939>Execute a build step based on a condition</a>.
The ticket is over 4.5 years old so whether the feature will be implemented
remains to be seen (one would think not).</p><p>Thinking about why this seemingly innocuous feature might not have been
implemented, it struck me that build pipelines should be all about procedural
steps that produce the same outcome each and every time they are executed. This
is what builds (no pun intended) trust in the process and allows people to rely
on them. Adding conditional logic is adding something that might go wrong, and
things often go wrong when you least want them to (and have forgotten about the
condition even existing)!</p><h2 id=possible-solutions>Possible solutions</h2><p>In the ticket a number of commenters share their workarounds.</p><ul><li>Some people create additional build configurations and use VCS triggers to
control which branch goes through which build configuration.</li><li>Others look to leverage the shell and environment variables to control what
happens within a single build configuration.</li></ul><p>Thinking about the implications of the two options I decided to use a
PowerShell script to control the generation of the NuGet package. I chose this
option primarily due to GitLab only supporting a single TeamCity build
configuration and I wanted to maintain the integration between GitLab and
TeamCity.</p><h2 id=nuget-creation-via-powershell>NuGet creation via PowerShell</h2><p>The PowerShell script I ended up with is:</p><script type=application/javascript src=https://gist.github.com/st3v3nhunt/48a8009c03608b3870596cdae0e09da7.js></script><p>The logic is straight forward enough, if the branch is determined to be the
default one, create a package based on the build number e.g. <code>1.0.12</code>. If the
branch is not default, a
<a href=https://docs.nuget.org/create/versioning#user-content-prerelease-versions>pre-release version</a>
will be created with the date and time the package was created e.g.
<code>1.0.11-pre20160418093024</code>. The reason for prepending the time stamp with <code>pre</code>
is to make the version number valid due to the pre-release section not able to
be purely numeric. Another change I had to make to the way I was originally
going to set the pre-release section (based on branch name) was due to the
length limitation of 20 characters max. The time stamp is a fixed length, until
we get to the year 10,000 AD at least.</p><p>Taking this approach allows all branch builds to be visible in the NuGet feed
but only those built from <code>master</code> are not marked as pre-release. This means as
we develop the package we can select specific pre-release versions to test
before merging them into <code>master</code>, should we wish.</p></div><div class="navigation navigation-single"><a href=/posts/development/diy-git-remote/ class=navigation-prev><i aria-hidden=true class="fa fa-chevron-left"></i><span class=navigation-tittle>DIY git remotes</span></a>
<a href=/posts/development/teacmity-pipeline-iteration-two/ class=navigation-next><span class=navigation-tittle>TeamCity Pipeline - iteration two</span>
<i aria-hidden=true class="fa fa-chevron-right"></i></a></div></article></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-21223368-5','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script defer src=https://use.fontawesome.com/releases/v5.12.1/js/all.js integrity=sha384-ZbbbT1gw3joYkKRqh0kWyRp32UAvdqkpbLedQJSlnI8iLQcFVxaGyrOgOJiDQTTR crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js></script><script type=text/javascript>hljs.initHighlightingOnLoad();</script></body></html>